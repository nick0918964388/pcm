#!/usr/bin/env tsx

/**
 * ä¿®å¾©Oracle PCMç”¨æˆ¶æ¬Šé™è…³æœ¬
 */

import oracledb from 'oracledb';

async function fixOraclePermissions() {
  console.log('ğŸ”§ ä¿®å¾©Oracle PCMç”¨æˆ¶æ¬Šé™...');

  let systemConnection: oracledb.Connection | undefined;
  let pcmConnection: oracledb.Connection | undefined;

  try {
    // ä½¿ç”¨systemç”¨æˆ¶é€£ç·š
    systemConnection = await oracledb.getConnection({
      user: 'system',
      password: 'Oracle123',
      connectString: 'localhost:1521/XE',
    });

    console.log('âœ… Systemç”¨æˆ¶é€£ç·šæˆåŠŸ');

    // æª¢æŸ¥PCM_USERæ˜¯å¦å­˜åœ¨
    const userCheckResult = await systemConnection.execute(
      'SELECT username, account_status FROM dba_users WHERE username = :username',
      { username: 'PCM_USER' }
    );

    if (!userCheckResult.rows || userCheckResult.rows.length === 0) {
      console.log('âŒ PCM_USERä¸å­˜åœ¨ï¼Œæ­£åœ¨å»ºç«‹...');

      // å»ºç«‹PCMç”¨æˆ¶
      await systemConnection.execute(`
        CREATE USER pcm_user IDENTIFIED BY pcm_pass123
        DEFAULT TABLESPACE USERS
        TEMPORARY TABLESPACE TEMP
        QUOTA UNLIMITED ON USERS
      `);

      console.log('âœ… PCM_USERå·²å»ºç«‹');
    } else {
      console.log(
        `âœ… PCM_USERå·²å­˜åœ¨ï¼Œç‹€æ…‹: ${(userCheckResult.rows[0] as any[])[1]}`
      );
    }

    // æˆäºˆæ‰€æœ‰å¿…è¦æ¬Šé™
    const permissions = [
      'GRANT CONNECT, RESOURCE TO pcm_user',
      'GRANT CREATE TABLE TO pcm_user',
      'GRANT CREATE VIEW TO pcm_user',
      'GRANT CREATE SEQUENCE TO pcm_user',
      'GRANT CREATE TRIGGER TO pcm_user',
      'GRANT CREATE PROCEDURE TO pcm_user',
      'GRANT CREATE SYNONYM TO pcm_user',
      'GRANT ALTER SESSION TO pcm_user',
      'GRANT CREATE SESSION TO pcm_user',
    ];

    for (const permission of permissions) {
      try {
        await systemConnection.execute(permission);
        console.log(
          `âœ… æˆäºˆæ¬Šé™: ${permission.split(' ').slice(-2).join(' ')}`
        );
      } catch (error) {
        console.log(
          `âš ï¸  æ¬Šé™å¯èƒ½å·²å­˜åœ¨: ${permission.split(' ').slice(-2).join(' ')}`
        );
      }
    }

    await systemConnection.commit();
    console.log('âœ… æ¬Šé™è¨­å®šå®Œæˆ');

    // æ¸¬è©¦PCMç”¨æˆ¶é€£ç·š
    try {
      pcmConnection = await oracledb.getConnection({
        user: 'pcm_user',
        password: 'pcm_pass123',
        connectString: 'localhost:1521/XE',
      });

      console.log('âœ… PCMç”¨æˆ¶é€£ç·šæ¸¬è©¦æˆåŠŸ');

      // å»ºç«‹åŸºæœ¬è¡¨æ ¼
      try {
        await pcmConnection.execute(`
          CREATE TABLE migration_history (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            script_name VARCHAR2(255) NOT NULL,
            executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            success NUMBER(1) DEFAULT 1 CHECK (success IN (0, 1)),
            error_message CLOB,
            CONSTRAINT uk_migration_script UNIQUE (script_name)
          )
        `);
        console.log('âœ… migration_historyè¡¨å·²å»ºç«‹');
      } catch (error) {
        if (String(error).includes('ORA-00955')) {
          console.log('âš ï¸  migration_historyè¡¨å·²å­˜åœ¨');
        } else {
          throw error;
        }
      }

      try {
        await pcmConnection.execute(`
          CREATE TABLE system_info (
            key_name VARCHAR2(100) PRIMARY KEY,
            key_value VARCHAR2(4000),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
          )
        `);
        console.log('âœ… system_infoè¡¨å·²å»ºç«‹');
      } catch (error) {
        if (String(error).includes('ORA-00955')) {
          console.log('âš ï¸  system_infoè¡¨å·²å­˜åœ¨');
        } else {
          throw error;
        }
      }

      // ç¢ºä¿system_infoæœ‰åˆå§‹è³‡æ–™
      try {
        await pcmConnection.execute(`
          INSERT INTO system_info (key_name, key_value)
          SELECT 'schema_version', '1.0.0' FROM dual
          WHERE NOT EXISTS (SELECT 1 FROM system_info WHERE key_name = 'schema_version')
        `);

        await pcmConnection.execute(`
          INSERT INTO system_info (key_name, key_value)
          SELECT 'migration_status', 'initialized' FROM dual
          WHERE NOT EXISTS (SELECT 1 FROM system_info WHERE key_name = 'migration_status')
        `);

        await pcmConnection.commit();
        console.log('âœ… system_infoåˆå§‹è³‡æ–™å·²æ’å…¥');
      } catch (error) {
        console.log(`âš ï¸  åˆå§‹è³‡æ–™å¯èƒ½å·²å­˜åœ¨: ${error}`);
      }

      // æª¢æŸ¥è¡¨ç‹€æ…‹
      const tableCheck = await pcmConnection.execute(
        'SELECT table_name FROM user_tables'
      );
      console.log(`âœ… PCMç”¨æˆ¶æ“æœ‰ ${tableCheck.rows?.length || 0} å€‹è¡¨`);
    } catch (error) {
      console.error('âŒ PCMç”¨æˆ¶é€£ç·šå¤±æ•—:', error);
    }
  } catch (error) {
    console.error('âŒ ä¿®å¾©æ¬Šé™å¤±æ•—:', error);
    process.exit(1);
  } finally {
    if (systemConnection) {
      await systemConnection.close();
    }
    if (pcmConnection) {
      await pcmConnection.close();
    }
  }

  console.log('ğŸ‰ Oracleæ¬Šé™ä¿®å¾©å®Œæˆï¼');
}

// åŸ·è¡Œä¿®å¾©
if (require.main === module) {
  fixOraclePermissions().catch(console.error);
}

export { fixOraclePermissions };
